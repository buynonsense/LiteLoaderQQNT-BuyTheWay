# LiteLoaderQQNT-BuyTheWay

[![GitHub release (latest by date)](https://img.shields.io/github/v/release/buynonsense/LiteLoaderQQNT-BuyTheWay?style=flat-square)](https://github.com/buynonsense/LiteLoaderQQNT-BuyTheWay/releases/latest)

一个为 [LiteLoaderQQNT](https://github.com/LiteLoaderQQNT/LiteLoaderQQNT) 开发的插件，用于监控指定QQ群聊或用户（通过用户ID）的消息。当消息内容包含预设的关键词时（或关键词列表为空时监控所有消息），插件可以将该消息（包括文本和图片）通过QQ或Email转发给指定的用户或群组。

## ✨ 功能特性

*   **群聊/用户监控**: 指定一个或多个QQ群或用户ID进行消息监控。
    *   支持在ID后添加备注，方便识别 (例如 `123456789 (技术交流群)` 或 `987654321 (张三)`)。
*   **关键词匹配**:
    *   设置关注的关键词列表（每行一个）。
    *   匹配时不区分大小写。
    *   **如果关键词列表为空，则监控指定群聊/用户中的所有消息。**
*   **强大的图片消息处理 (依赖 Euphony)**:
    *   能够捕获消息中的图片内容 (优先使用缩略图以提高效率)。
    *   支持将图片作为附件通过邮件发送，并在邮件正文中内嵌预览。
    *   支持将图片与文本合并在一条消息中通过 `MessageChain` 转发给QQ好友和群组。
*   **灵活的消息转发 (依赖 Euphony)**:
    *   转发到指定的QQ好友（文本和图片合并发送）。
    *   转发到指定的QQ群组（文本和图片合并发送）。
    *   通过配置好的SMTP服务器发送邮件通知（文本和图片附件，支持HTML格式和图片内嵌预览）。
*   **高度可配置**:
    *   **总开关**: 一键启用或禁用整个插件功能。
    *   **配置管理**:
        *   支持将所有插件设置导入/导出为一个 `.json` 文件，方便备份和迁移。
        *   关键词列表、监控列表、转发用户列表、转发群组列表均支持单独导入/导出为 `.txt` 文件。
    *   **注释支持**: 在监控群聊/用户、转发用户、转发群组的ID列表中可以添加中文、英文或符号注释，插件会自动提取数字ID。
    *   **消息格式模板**: 提供多种预设的消息输出格式模板，可自定义转发消息的排版风格。
    *   **自动保存**: 设置界面的更改会自动保存，无需手动点击保存按钮。
    *   **邮件测试**: 提供测试按钮，验证邮件发送配置是否正确。
*   **消息输出美化器**: 可选择不同的消息格式模板进行转发。

## 🚀 安装

1.  确保您已安装并启用了最新版的 [LiteLoaderQQNT](https://github.com/LiteLoaderQQNT/LiteLoaderQQNT)。
2.  **[重要]** 确保已安装并启用 **`euphony` 插件**。本插件的核心消息监听和QQ转发功能**强依赖** `euphony` 插件。如果 `euphony` 未安装或未正常工作，本插件将无法捕获消息或进行QQ转发。
3.  从本项目的 [Releases](https://github.com/Buynonsense/LiteLoaderQQNT-BuyTheWay/releases) 页面下载最新的 `LiteLoaderQQNT-BuyTheWay-vX.X.X.zip` 压缩包 (通常是 Source code (zip))。
4.  将下载的压缩包解压，您会得到一个名为 `LiteLoaderQQNT-BuyTheWay-main` (或类似，包含 `manifest.json` 的文件夹) 的文件夹。
5.  将此文件夹完整复制到 LiteLoaderQQNT 的插件目录 (通常是 `LiteLoaderQQNT安装目录/plugins/`，如果插件目录是 `data/plugins`，请放入 `data/plugins/` 下)。确保最终的目录结构类似 `.../plugins/LiteLoaderQQNT-BuyTheWay-main/manifest.json`。
6.  重启 QQNT。

## ⚙️ 配置

插件安装并启用后，可以通过 LiteLoaderQQNT 的插件设置菜单访问 "BuyTheWay" 的设置界面。

主要配置项说明：

*   **总开关**:
    *   `启用插件`: 勾选此项以启用插件的所有功能。取消勾选则禁用。
*   **配置管理**:
    *   `导出所有配置`: 将当前所有设置导出为一个 `buytheway_settings.json` 文件。
    *   `导入所有配置`: 从 `.json` 文件导入之前保存的设置，导入后会自动应用并保存。
*   **通用设置**:
    *   `关注的关键词`: 每行输入一个关键词。如果此列表为空，插件将监控指定群聊/用户中的所有消息。支持导入/导出 `.txt` 文件。
    *   `监控的群聊/用户 ID`: 每行输入一个群号或用户QQ号。可以在ID后添加注释，例如 `123456789 (技术交流群)` 或 `987654321 (老板)`。插件会自动提取数字部分作为有效的ID。支持导入/导出 `.txt` 文件。
    *   `消息输出格式模板`: 选择转发消息时使用的格式，例如默认、Emoji排版、Markdown等。
*   **转发设置**:
    *   `启用转发到QQ用户`: 勾选以启用转发给指定QQ好友的功能。
    *   `转发到QQ用户列表`: 每行输入一个QQ号，同样支持添加注释。支持导入/导出 `.txt` 文件。
    *   `启用转发到QQ群`: 勾选以启用转发给指定QQ群的功能。
    *   `转发到QQ群列表`: 每行输入一个群号，同样支持添加注释。支持导入/导出 `.txt` 文件。
*   **邮件通知设置**:
    *   `启用邮件通知`: 勾选以启用邮件转发功能。
    *   `SMTP服务器地址`, `端口`, `使用SSL/TLS加密`: 填写您的邮箱提供商的SMTP服务器信息。(例如 QQ邮箱: `smtp.qq.com`, SSL端口 `465`)
    *   `邮箱账号`, `邮箱密码/授权码`: 用于登录SMTP服务器的凭据。**提示**: QQ邮箱等邮箱服务商通常需要生成应用专用密码或授权码，而不是直接使用登录密码。请查阅您邮箱服务商的帮助文档。
    *   `收件人邮箱`: 接收通知邮件的邮箱地址，多个邮箱请用英文逗号 `,` 隔开。
    *   `测试发送邮件`: 点击此按钮测试邮件配置是否正确。

所有设置项在修改后会自动保存。配置会保存在 LiteLoaderQQNT 数据目录下的 `data/buy_the_way/settings.json` 文件中。

## 📝 使用说明

1.  根据您的需求完成插件配置。
2.  确保插件总开关已启用，并且 **Euphony 插件已正确安装、启用并运行**。
3.  当被监控的群聊或用户中出现新消息时：
    *   如果关键词列表不为空，插件会检查消息内容（包括文本）是否包含任一关键词（不区分大小写）。
    *   如果关键词列表为空，则所有来自受监控来源的消息都视为匹配。
    *   如果消息匹配成功，插件将根据您的转发设置：
        *   **邮件转发**: 将格式化后的消息文本和图片（作为附件并内嵌预览）发送到指定邮箱。
        *   **QQ转发**: 将格式化后的消息文本和图片合并为一条消息，通过 Euphony 发送给指定的QQ用户或QQ群。

## ❓ 故障排查与注意事项

*   **日志查看**: 插件的大部分操作都会在 QQNT 的开发者工具控制台输出日志，日志以 `[BuyTheWay]` 开头。如果遇到问题，请按 `F12` (可能需要先安装 Chii DevTools 插件) 打开控制台查看相关输出。
*   **Euphony 依赖**: **这是最重要的依赖项。** 本插件的核心消息监听和QQ转发功能**强依赖** `euphony` 插件。请确保 `euphony` 插件已正确安装、启用，并且版本兼容。如果 `euphony` 未能正常工作或未加载，本插件的消息捕获和QQ转发功能将无法使用。请检查控制台是否有 `euphony` 相关的错误日志。
*   **图片路径与获取**:
    *   插件通过 Euphony 获取图片在您本地的缓存路径。为提高效率，优先尝试获取缩略图。
    *   如果QQ在后台运行或网络不佳，原图可能未及时下载，此时插件会尝试使用已下载的缩略图。如果两者都无法获取，图片可能无法成功转发。
*   **邮件发送失败**:
    *   仔细检查 SMTP 服务器地址、端口、加密方式、邮箱账号和**密码/授权码**是否正确。
    *   确认您的邮箱账号已开启SMTP服务，并且使用的是正确的授权码（而非邮箱登录密码）。
    *   部分邮箱服务商可能会阻止来自未知应用的登录，请查阅邮箱服务商的帮助文档。
    *   检查网络连接和防火墙设置。
*   **QQ转发失败**:
    *   首先确保 `euphony` 插件工作正常。
    *   QQ版本更新可能会影响 Euphony 的兼容性，进而影响本插件的转发功能。
*   **ID列表中的备注**: 当您在监控列表或转发目标列表中使用如 `123456789 (备注)` 的格式时，插件会提取 `123456789` 作为实际操作的ID。备注仅为方便您在设置中识别。
*   **配置丢失/未保存**: 插件配置保存在 LiteLoaderQQNT 数据目录下的 `plugins_data/buy_the_way/settings.json` 文件中。请确保 LiteLoaderQQNT 对该路径有读写权限。

## 📄 许可证

[MIT](./LICENSE)